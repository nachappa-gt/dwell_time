#!/bin/env python2.7
#
# Copyright (C) 2016. xAd, Inc.  All Rights Reserved.
#

"""
Main function for xcp.

@author: victor
"""

import sys
sys.path.append('/home/xad/share/python')
import argparse
import datetime
import getpass
import traceback
import logging
import re
import smtplib
import socket
from argparse import RawTextHelpFormatter
from email.mime.text import MIMEText

from xad.common.conf import Conf
from xad.xcp.dispatcher import Dispatcher


# Constants
DEFAULT_CONFIG_DIRS = "/home/xad/xcp/config:/home/xad/share/config"
DEFAULT_CONFIG_FILE = "xcp.properties"
DEFAULT_ALERT_EMAIL = 'victor.chu@xad.com'
DEFAULT_EMAIL_PRIORITY = '0'
DEBUG = False

DESC = """
NAME:
    xcp.py -- xAd tool for downloading data to HDFS from various sources.

DESCRIPTION:
    This tool download data to HDFS from verious sources, such as Amazon S3,
    PostgreSQL and MySQL.

    For S3, it uses the Hadoop distcp.  For databases, it uses sqoop.

    Default options are defined in the configueration files under

        /home/xad/xcp/config/

COMMANDS:
    This tool takes one or many commands.  A complete list of commands and
    alises can be found in the configuration file:

        /home/xad/xcp/config/commands.properties

    Some commands are "single" commands.  Some are "composite" commands.
    The priority of the commands are determined by the value part of
    these commands in the configuration file.
    
    Some commands are implemented in Perl.  Some are supported in Python.

    poidb-get OR poi-get
       Download selected POI fields from the POI DB.
       Files will be stored in HDFS under /data/poidb.
       A date folder will be created for each download.
    
    poidb-clean OR poi-clean
       Delete older POI DB files.
"""
conf = None


def parse_arguments():
    """Parse command line arguments."""
    parser = argparse.ArgumentParser(description=DESC,
                                     formatter_class=RawTextHelpFormatter)
    # Command List - one or many.  See DESC
    parser.add_argument("cmds", metavar='cmd', nargs="+", help="command list")

    # Configuration dir and file
    parser.add_argument('--config_dirs', help="Configuration search dirs",
                        default=DEFAULT_CONFIG_DIRS)
    parser.add_argument('--config', help="Configuration file",
                        default=DEFAULT_CONFIG_FILE)
    parser.add_argument('--country', help="Countries")
    parser.add_argument('--date', help="Date(s)")
    parser.add_argument('-d', '--debug', action='store_true',
                        help="Turn on debugging")
    parser.add_argument('--fill', help="Select the fill/nf folder")
    parser.add_argument('-f', '--force', action='store_true',
                        help="Force the execution")
    parser.add_argument('--hour', help="Hour(s)")
    parser.add_argument('--keep', action='store_true',
                        help="Keep old output files")
    parser.add_argument('-l', '--lock', help="Define custom lock file",
                        default="lock")
    parser.add_argument('--logtype', 
                        help="Log types (e.g. exchange, display, euwest1); aka product types")
    parser.add_argument('-m', '--maxmaps', help="Maximum number of mappers")
    parser.add_argument('-n', '--norun', action='store_true',
                        help="No run.")
    parser.add_argument('-ne', '--noemail', action='store_true',
                        help="No email.")
    parser.add_argument('-nl', '--nolock', action='store_true',
                        help="No locking")
    parser.add_argument('--output', help="Temporary HDFS output folders")
    parser.add_argument('-q', '--queue', help="YARN queue name")
    parser.add_argument('--sl', help="Select the sl confidence {tll,pos.rest}")

    opt = parser.parse_args()

    return(opt)


def init_logging(opt):
    """Initialize logging"""
    global logger

    # Set logging level
    if (opt.debug):
        level = logging.DEBUG
    else:
        level = logging.INFO

    #fmt = ("%(asctime)s:%(name)s %(levelname)s " + "[%(module)s:%(funcName)s] %(message)s")
    #fmt = ("[%(module)s:%(funcName)s] %(levelname)s %(message)s")
    fmt = ("[%(module)s] %(levelname)s %(message)s")
    #datefmt = '%m/%d %H:%M:%S'
    datefmt = '%H:%M:%S'
    logging.basicConfig(format=fmt, datefmt=datefmt, level=level)

    # IPython specific setting
    logger = logging.getLogger()
    logger.setLevel(level)
    logger.debug('Initialized logger')


def load_configuration(opt):
    """Load configuration files"""
    logger.debug("Loading configuration")
    conf = Conf()
    conf.load(opt.config, opt.config_dirs)
    if (DEBUG): conf.dump()
    return(conf)


def exceptionHandler(e):
    """Handle exceptions"""
    global opt, conf

    # Get parameters from the configuration if it is available.
    host = socket.gethostname();
    if (conf):
        to_addr = conf.get('alert.email')
        priority = conf.get('alert.email.priority')
        if (conf.has('local.host.id')):
            host = conf.get('local.host.id')
    else:
        to_addr = DEFAULT_ALERT_EMAIL
        priority = DEFAULT_EMAIL_PRIORITY

    if (opt):
        noemail = opt.noemail or opt.norun
    else:
        noemail = False

    # Trace Back
    tb = traceback.format_exc()

    # Get the user name and the host name
    user = getpass.getuser()
    from_addr = '{}@{}'.format(user, host)

    # Construct the email body and header
    msgArray = [str(e), "", "---", tb]
    email = MIMEText("\n".join(msgArray))
    email['Subject'] = '[ALERT] XCP-PY ({})'.format(host)
    email['From'] = from_addr
    email['To'] = to_addr
    if (priority != '0'):
        email['X-Priority'] = priority

    logging.debug(str(e))
    print("\n" + str(email) + "\n")

    # Send the email unless --norun or --noemail options are set
    if (not noemail):
        logging.info('Sending email...')
        s = smtplib.SMTP('localhost')
        s.sendmail(email['From'],
                   re.split('[\s,]+', email['To']),
                   email.as_string())
        s.quit()
    else:
        logging.info('==> NO EMAIL!')


def main():
    """The Main Function"""
    global conf, opt
    try:
        # Parse command line arguments
        opt = parse_arguments()
        # Initiate logging
        init_logging(opt)
        # Load configuration
        conf = load_configuration(opt)
        # Create the main object
        dispatcher = Dispatcher(conf, opt)
        dispatcher.run()

    except Exception as e:
        exceptionHandler(e)

    except:
        logging.warn('Un-expected exception')
        e = sys.exc_info()
        exceptionHandler(e)


if (__name__ == "__main__"):
    main()


